<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#">
	<head>
		<title>Maintenance of Clearnets - Cookie Engineer's Web Log</title>

		<!-- Meta -->
		<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=0.5, maximum-scale=2, user-scalable=yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="creator" content="Cookie Engineer">
		<meta name="description" content="Maintenance of Clearnets">
		<meta name="keywords" content="privacy, security, network, web browser">
		<meta name="generator" content="Hands of Cookie Engineer with some beer and VIM night coding sessions">
		<meta name="robots" content="index, follow">
		<link rel="alternate" type="application/rss+xml" href="../feed.xml">

		<!-- Social Meta -->
		<meta name="og:image" itemprop="image" content="https://cookie.engineer/design/cookiengineer.png">
		<meta name="og:title" content="Maintenance of Clearnets - Cookie Engineer's Web Log">
		<meta name="og:description" content="Maintenance of Clearnets">
		<meta name="og:site_name" content="Cookie Engineer's Web Log">
		<meta name="og:type" content="article">
		<meta name="twitter:card" content="summary">
		<meta name="twitter:domain" content="cookie.engineer">
		<meta name="twitter:title" property="og:title" itemprop="name" content="Maintenance of Clearnets - Cookie Engineer's Web Log">
		<meta name="twitter:description" property="og:description" itemprop="description" content="Maintenance of Clearnets">

		<!-- Website Content -->
		<link rel="stylesheet" href="../../design/fontello.css">
		<link rel="stylesheet" href="../../design/layout.css">

		<!-- Website Design -->
		<link rel="stylesheet" href="../../design/weblog/weblog.css">

		<!-- Website Functionality -->
		<link rel="stylesheet" href="../../design/menu.css">
		<script src="../../design/menu.js"></script>

		<!-- Magic: Copy/Paste/Save -->
		<link rel="stylesheet" href="../../design/copypaste.css">
		<script src="../../design/copypaste.js"></script>
		<link rel="stylesheet" href="../../design/save.css">
		<script src="../../design/save.js"></script>

		<!-- Magic: Highlight -->
		<link rel="stylesheet" href="../../design/weblog/highlight.css">
		<script src="../../design/weblog/highlight.js"></script>
	</head>
	<body>
		<header>
			<aside id="menu" class="visible">
				<button id="menu-button"><i></i></button>
				<!-- TBD -->
				<a class="icon-section" href="../index.html">Web Log</a>
				<a class="icon-section" href="../../index.html">Portfolio</a>
			</aside>
		</header>
		<section id="weblog">
			<h1>Maintenance of Clearnets</h1>
			<article>
				<p>
	In order to understand how we can break out of Prison, we must first
	understand how the Prison operates, how the Guards spot means of
	Breakouts (Tools, Weapons), how they rotate their watch shifts; and
	how they generally behave and react to things that are going on inside
	the Prison.
</p>
<p>
	The same applies for a Breakout of the Clearnet. In general, Internet
	Service Providers (ISPs) use a couple of techniques in parallel to make
	your experience of the Internet as bad as possible.
</p>
<p>
	When we talk about how they operate, we must assume that the ISP is
	always the Man in the Middle (MITM) and can read, understand and
	manipulate any unencrypted data that is transferred between you, Alice,
	and Bob, the server that you're communicating to.
</p>
<h3>Operating System</h3>
<p>
	In general I'd recommend to use an up-to-date Linux Distribution for
	means of access of the internet. Network behaviour on MacOS and Windows
	cannot be guaranteed anyhow; therefore it is heavily disrecommended
	if you're serious about your Privacy.
</p>
<p>
	And you should be, because Governments have lots of Exploits already
	available that are automatically installed on your Computer; no matter
	if you're the bad guy or a nice guy. They don't care.
</p>
<h3>General Hints for Dealing with Customs</h3>
<p>
	Always use an up-to-date Linux Distribution (like Arch Linux), always
	encrypt all your partitions, always use a small nano-USB-thumbdrive as
	a crypto unlock key file in combination with a password. They also come
	in the form of a wedding ring or necklace. If you travel with a dog or
	cat, that's even better.
</p>
<p>
	Always power down your Laptop; and remove the thumbdrive before walking
	through Customs at the Country Border.
</p>
<p>
	In my case, I also only use Libreboot-compatible Hardware; which means
	it is a bit out of date by performance standards... but with the ongoing
	never-ending shitstorm about Bugs, Backdoors and Exploits in more modern
	Intel processors I'm quite happy with that decision.
</p>
<p>
	You'll be amazed how often Customs will ask you whether your Laptop is
	broken or not when they cannot boot it up ... which should be a hint
	that they unsuccessfully tried to invade your Privacy, and tried to
	install Spyware on your Computer without your permission.
</p>
<h2>The OSI Model</h2>
<p>
	In order to understand how the Prison operates, you have to understand
	how the internet and its underlying network infrastructure works.
</p>
<p>
	When talking about the Web, most people understand it as 
	 <code>E-Mail</code>
	 and
	 <code>Websites</code>
	, maybe even 
	 <code>VPN</code>
	 but not nerdy things like IRC or ICMP.
</p>
<p>
	Therefore this Guide will focus on the problems of 
	 <code>TCP</code>
	 and 
	 <code>UDP</code>
	based internet connections.
</p>
<p>
	When talking about Network Protocols, they are divided in different
	OSI layers which each add different capabilities to the network protocol.
	These days the lines in between blurr up a little, but the basic
	principles are the same.
</p>
<p>
	The OSI Layers that are interesting to us are
	:
</p>
<ol>
	<li>The <code>Physical Layer</code> connects machines via a transmission medium, like a network cable (or Wi-Fi or radio).</li>
	<li>The <code>Data Link Layer</code> links specific machines together, which are addressed via <code>MAC addresses</code> (also known as hardware addresses).</li>
	<li>The <code>Network Layer</code> links specific network sockets together, which are addressed via <code>IP addresses</code> .</li>
	<li>The <code>Transport Layer</code> defines the network socket data frames and its contents and mechanics (like <code>TCP</code> or <code>UDP</code> ).</li>
	<li>The <code>Session Layer</code> defines ids and temporary sessions. In our case this is only interesting for the <code>SOCKS</code> proxy routing protocol.</li>
	<li>The <code>Presentation Layer</code> defines encryption/decryption, for example an <code>SSL</code> or <code>TLS</code> session.</li>
	<li>The <code>Application Layer</code> is the high-level network protocol that Applications work with, for example <code>HTTP/HTTPS</code> or <code>SMTP/IMAP</code> .</li>
</ol>
<p>
	Usually when network administrators talk about broken infrastructure,
	they tend to talk about which OSI layer is affected by the Bug. This
	helps them to identify the Bug more quickly and to trace down the
	broken Hardware or Firmware/Software.
</p>
<p>
	A broken OSI Layer 1 means that a Network Hub or a Network Cable is
	broken. When OSI Layer 2 is affected, it concludes that a Network
	Switch or a piece of software (Firewall) that knows things about MAC
	and IP relationships is not working. When OSI Layer 3 is broken, it
	usually means that a Router or Gateway doesn't work as intended.
</p>
<p>
	This goes on and on for each OSI Layer, in our case only these three
	layers are generally interesting when breaking out of the Clearnet
	(Censored Internet).
</p>
<h2>Blocking Techniques</h2>
<p>
	There are several ways on what is actually done in order to block as
	much "unwanted" Network Traffic as possible. Most of the time, only
	one of the following Hurdles is actually necessary; but most
	Governments have multiple ones in place to achieve maximum control
	of their Zombie inhabitants.
</p>
<h3>MAC Address Blocking (Layer 2)</h3>
<p>
	In general, network connections are automatically tagged by ISPs. If
	they can see your MAC address, they'll also identify you by your MAC
	address. Many "Free Wi-Fi" Router Firmwares actually report the
	contents of their Network Address Translation Table (NAT) and therefore
	the MAC and IP addresses back to the ISPs.
</p>
<p>
	That's why it's important to randomize your MAC address not only for
	Wi-Fi connections, but also for cable connections.
</p>
<pre class="bash">
# Assumes enp3s0 is your cable connection
sudo macchanger -r enp3s0;

# Assumes wlp3s0 is your wifi connection
sudo macchanger -r wlp3s0;
</pre>
<p>
	Deactivate all Wi-Fi autoconnect features in order to prevent being
	traceable by the Wi-Fi networks that your Wi-Fi card tries to ping
	when being disconnected.
</p>
<p>
	In Network Manager Profiles, you can add these settings to your Connection
	that is located in 
	 <code>/etc/NetworkManager/system-connections/*.nmconnection</code>
	.
</p>
<p>
	Edit the file as 
	 <code>root</code>
	 (not via 
	 <code>sudo</code>
	) and keep the 
	 <code>chmod</code>
	 of the
	file identical. Otherwise NetworkManager will forget the Connection
	Settings and mess things up.
</p>
<pre class="ini">
; mac-address generated via macchanger -sr wlp3s0

[connection]
id=Example-WiFi
(...)
type=wifi
autoconnect=false

[wifi]
mac-address=00:01:02:03:04:05
[ipv4]
dhcp-send-hostname=false

[ipv6]
dhcp-send-hostname=false
</pre>
<h3>TCP RST Injection (Layer 4)</h3>
<p>
	TCP is a very nice Network Protocol, but it has an essential flaw which
	is called Fragmentation.
</p>
<p>
	The underlying TCP data frame starts with a so-called 
	 <code>FIN</code>
	 flag, which
	represents whether or not the data frame is 
	 <code>finished</code>
	 and can be
	processed by the software that receives it. When the 
	 <code>FIN</code>
	 flag is set
	to 
	 <code>0</code>
	, it means that the software will continue to wait until new data
	arrives; and try to put the upcoming chunks together when they arrive;
	into this big, locally maintained history of past uncomplete chunks.
</p>
<p>
	Additionally, TCP has a feature called 
	 <code>RST</code>
	 which is basically a message
	that says 
	 <code>Hold on ... I haven't forgot about you, I just need a while ...</code>
	which means that the software will wait for the next data frame, and
	usually it does so longer than it would without by resetting the local
	timeout.
</p>
<p>
	For example, when a software would time out after 30 seconds of waiting,
	the only thing an ISP would have to do is sending another 
	 <code>RST</code>
	 packet
	every 30 seconds and manipulate all incoming TCP frames to 
	 <code>FIN=0</code>
	 to
	slow down the software dramatically.
</p>
<p>Literally this is what happens on throttled "Flatrate" 3G/4G connections.</p>
<p>
	The bandwidth of HSPA+ or LTE is too fast to send just 4kiB/s (note that
	kiBiBit is not kiloBit is not kiloByte), so ISPs use this technique in
	order to slow it down to the minimum speeds until all software (read
	as
	:
	 Web Browsers) break. Literally everything else like IMAP-based
	email will break all the time and throw an absurd amount of errors.
</p>
<h3>VPN Connections (Layer 2/4/7)</h3>
<p>
	What is important here is that plain VPN connections that are TCP-based
	are also affected by the TCP 
	 <code>FIN</code>
	 and 
	 <code>RST</code>
	 flaw and therefore cannot
	be relied on.
</p>
<p>
	VPN connections are auto-tagged and auto-throttled when they do connect
	to certain networks or IP ranges in specific geolocation areas (e.g.
	Sweden or Switzerland are off limits, usually).
</p>
<p>
	Additionally popular VPN providers usually are auto-blocked via an
	IP-based blocklist which means that everything above Layer 2 will not
	work and they're basically just a big waste of money.
</p>
<h3>SOCKS Proxies (Layer 5)</h3>
<p>
	SOCKS Proxies are a different story and they are hard to explain as a
	Network Protocol, because SOCKS itself is actually not a Network Protocol
	but rather something like a Connection Creation Protocol.
</p>
<p>
	What SOCKS does is basically have a 
	 <code>Client > Proxy > Server</code>
	 connection,
	whereas the Proxy itself can be abused for Blocking Purposes or as a
	connection handler that sits in the middle.
</p>
<p>
	A SOCKS Proxy can be imagined as the Telephone Operator Lady that you
	could call when you had no idea what the Number of the person was you
	were trying to call.
</p>
<p>
	The function of a SOCKS Proxy is similar in the sense that it does the
	connecting and forwarding part when only the Proxy is reachable, but
	not the Server that you're trying to communicate to.
</p>
<p>
	Anyhow SOCKS is unencrypted (below Layer 6) and therefore can be easily
	manipulated, and connections can be blocked as well. That's why it's
	just a matter of time before the new server pool behind projects like
	 <code>shadowsocks</code>
	 won't work anymore.
</p>
<h3>SSL/TLS Certificate Injection (Layer 6)</h3>
<p>
	Most people assume that when there's the Secure Icon in the Browser
	that it means the connection is secure, private, and safe.
</p>
<p>Guess what, you're wrong.</p>
<p>
	SSL was broken on uncountable accounts (Certificate Nulling, Sony Root
	Cert Leak, Weak Elliptic Curves, Heartbleed, Dragonblood and what not),
	and the new encryption protocol is called Transport Layer Security (TLS).
</p>
<p>
	But, TLS is also broken up until and including TLS 1.2. With the
	 <a class="icon-website" href="https://letsencrypt.org">letsencrypt</a> 
	 initiative the usage of the 
	 <code>SNI</code>
	field got so popular that now ISPs are meanwhile regularly abusing it
	to infiltrate encrypted connections.
</p>
<p>
	The 
	 <code>SNI</code>
	 stands for 
	 <code>Server Name Identification</code>
	 which basically allows
	a web hosting provider to have a single server that has multiple domains
	pointing to it; and that its software can deliver the correct encryption
	certificate for the currently requested domain.
</p>
<p>
	But, as you might have guessed, 
	 <code>SNI</code>
	 before TLS 1.3 (which isn't rolled
	out yet) was transferred unencrypted and lead to plain-old unencrypted DNS
	request for that very domain. As the DNS protocol is unencrypted, it
	lead to ISPs being able to manipulate that result; and therefore legitimize
	otherwise invalid certificates.
</p>
<p>
	So, always check for TLS 1.3 and above; and assume that TLS 1.2 and
	below are insecure. As TLS 1.2 and before is not really deprecated it
	will continue to help exploit users for a long time to come and it will
	take an even longer time to upgrade all those legacy websites running
	on legacy software.
</p>
<p>
	The only Browser that currently fixes this issue is the
	 <a class="icon-github" href="https://github.com/cookiengineer/stealth">Stealth</a> 
	 Browser. Yeah yeah,
	I know, shameless plug, but it's just so that you actively keep in mind
	that other Browsers aren't as secure as they claim to be; even when not
	talking about their always-on-not-actually-deactivateable tracking.
</p>
<h3>DNS Time-To-Live Manipulation (Layer 7)</h3>
<p>
	Even when your network connection is encrypted, your network might be
	compromised. Your Computer doesn't understand what 
	 <code>cookie.engineer</code>
	or 
	 <code>github.com</code>
	 means and needs a translation back to the underlying
	Layer 2 with an 
	 <code>IP address</code>
	 that represents that domain.
</p>
<p>
	In order to do so, there's 
	 <code>DNS</code>
	. Probably one of the oldest Network
	Protocols designed by ARPA. The important part here is that the 
	 <code>DNS</code>
	Network Protocol itself is unencrypted and that ISPs therefore abuse
	and manipulate it.
</p>
<p>
	Imagine you're an ISP and you want customer data insights about how
	much you can charge for an unlimited YouTube connection (yes, this is
	currently the case even in Germany, how's that for Net Neutrality).
</p>
<p>
	In that case you need to know how many of your customers are surfing
	how often on YouTube (or the Google Video CDN domains).
</p>
<p>
	What you, as an ISP, can do is pretty simple. The DNS Protocol has a
	so-called Time-To-Live field inside it, which means that the receiving
	Computer should forget about the Domain in 
	 <code>X seconds</code>
	 (quite literally)
	and Computers will gladly do so.
</p>
<p>
	So, if you visit 
	 <code>searx.me</code>
	, the Browser does a DNS request, then
	remembers the IP address, and only then connect to the Server via TCP
	(or HTTP/S). But if the 
	 <code>TTL</code>
	 field in the DNS request had the value
	 <code>0</code>
	, it will immediately forget about it... which means that when you
	loaded the page and you click a single link (that also is on 
	 <code>searx.me</code>
	)
	the Browser will end up doing a DNS request, again.
</p>
<p>
	And this continues, again and again... again and again. So even if the
	ISPs don't know the exact data that was transferred, they can basically
	log all the domain requests and times (and bandwidths of that internet
	connection) and then correlate back with their own downloaded versions
	of the website.
</p>
<p>
	This is literally how they know you've visited that exact Google Search
	Page already and how they know you've visited this particular Web Page
	on a specific Website... because usually, each Web Page has a unique
	amount of JavaScripts, CSS files and other media included (which will
	lead to DNS requests and is therefore trackable by ISPs).
</p>
<h3>HTTP Payload Manipulation (Layer 7)</h3>
<p>
	An also quite popular mechanism of ISPs to infiltrate your connection
	is a so-called HTTP Downgrade Attack that works usually in Firefox or
	(not-so-recent) Chrome versions.
</p>
<p>
	An HTTP Downgrade Attack is pretty simple. The Web Browser has a serious
	flaw
	:
	 It requests websites first via 
	 <code>HTTP</code>
	 and only then (optionally)
	upgrades the connection to 
	 <code>HTTPS</code>
	.
</p>
<p>
	ISPs manipulate the very first request, and basically remove the
	 <code>Connection: Upgrade</code>
	 instructions inside the Response in order to
	force the Web Browser into thinking that the Webserver only supports
	unencrypted connections.
</p>
<p>
	This method is used at least in North Korea, Myanmar, Thailand and
	China (judging from personal travel experience). I've also seen it in
	some networks in eastern parts of Ukraine, but I'm not sure whether
	or not that was ISP or Public Wi-Fi specific.
</p>
<p>
	Nevertheless this is the reason why 
	 <a class="icon-website" href="https://addons.mozilla.org/en-US/firefox/addon/https-everywhere/">HTTPS Everywhere</a> 
	should be mandatory for every Web Browser installation.
</p>
<h2>Breakout of Clearnets</h2>
<p>
	Now that we know how the Prison operates and how the Prison Guards
	rotate their watch shifts and where they stand guard, we can now
	discuss the Tools we need in order to breakout of the Prison.
</p>
<p>
	The follow-up article is 
	 <a class="icon-section" href="/weblog/articles/breakout-of-clearnets.html">Breakout of Clearnets</a> 
	and writes exactly about that.
</p>
			</article>
		</section>
		<footer>
			<p>Made with 💔 in Heidelberg, Germany. All rights (and jokes) reserved under European Law.</p>
		</footer>
		<dialog id="save">
			<article>
				<h3>Download Website <button id="save-close" title="Close Dialog">X</button></h3>
				<p>
					Usually, a Web Browser's <q>Save</q> functionality is severly broken
					and it auto-formats and auto-craps up all the HTML, CSS and JS.
					<br><br>
					This website includes Print Stylesheets, so you can also print it out
					by using <q>[Ctrl]+[P]</q> or the print feature of your Web Browser.
					<br><br>
					This website's source code is Open Source and can be downloaded from
					either of these repositories:
					<br><br>
					<a class="icon-github" href="https://github.com/cookiengineer/cookie.engineer" target="_blank">GitHub</a>
					or
					<a class="icon-gitlab" href="https://gitlab.com/cookiengineer/cookie.engineer" target="_blank">GitLab</a>
				</p>
			</article>
		</dialog>
		<script>
		if (typeof hljs !== 'undefined') {

			let codes = Array.from(document.querySelectorAll('pre[class]'));
			if (codes.length > 0) {

				codes.forEach((code) => {

					let lang = code.className || null;
					if (lang === 'javascript') {

						setTimeout(() => {

							Array.from(code.querySelectorAll('span.hljs-built_in')).forEach((node) => {

									let text = node.innerHTML || '';
									if (text === 'console') {
										node.className += ' hljs-console';
									}

							});

							Array.from(code.querySelectorAll('span.hljs-keyword')).forEach((node) => {

								let text = node.innerHTML || '';
								if (text === 'let') {
									node.className += ' hljs-let';
								} else if (text === 'new') {
									node.className += ' hljs-new';
								} else if (text === 'function') {
									node.className += ' hljs-function';
								}

							});

							Array.from(code.querySelectorAll('span.hljs-literal')).forEach((node) => {

								let text = node.innerHTML || '';
								if (text === 'null') {
									node.className += ' hljs-null';
								}

							});

						}, 500);

					}

					hljs.highlightBlock(code);

				});

			}

		}
		</script>
	</body>
</html>
